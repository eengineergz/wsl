"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var vscode_1=require("vscode"),Utils_1=require("../Utils"),DocumentUtils_1=require("./DocumentUtils"),Document=function(){function e(e){this.listeners=[],this.main=e,this.initialize()}return e.prototype.initialize=function(){var t=this;vscode_1.window.onDidChangeActiveTextEditor(function(e){t.editor=e,t.editor&&(t.update(),t.detailedUpdate())},null,this.main.context.subscriptions),vscode_1.workspace.onDidChangeTextDocument(function(e){t.editor&&e.document===t.editor.document&&(t.update(),t.detailedUpdate())},null,this.main.context.subscriptions),this.editor=vscode_1.window.activeTextEditor,process.nextTick(function(){t.update(),t.detailedUpdate()})},e.prototype.addListener=function(e){this.listeners.push(e)},e.prototype.update=function(){if(this.editor&&this.editor.document)for(var e=this.getDataInRange(this.editor.document.validateRange(new vscode_1.Range(0,0,this.editor.document.lineCount,0)),this.editor.document),t=0,i=this.listeners;t<i.length;t++){i[t].update(e)}else for(var o=0,n=this.listeners;o<n.length;o++){n[o].update()}},e.prototype.detailedUpdate=function(){var g=this;if(this.editor&&this.editor.document)DocumentUtils_1.default.getSymbols(this.editor.document).then(function(e){var t;if(g.editor&&g.editor.document&&e){for(var i=[],o=0,n=e;o<n.length;o++){var s=n[o];i.push.apply(i,DocumentUtils_1.default.getChildMembers(s))}for(var r={},d=0,a=i;d<a.length;d++){s=a[d];for(var u=g.getDataInRange(s.range,g.editor.document),l=0,c=Object.keys(u);l<c.length;l++){var h=c[l];r[h]?(r[h].amount+=u[h].amount,(t=r[h].items).push.apply(t,u[h].items)):r[h]=u[h]}}for(var p=0,f=g.listeners;p<f.length;p++){f[p].detailedUpdate(r)}}else for(var v=0,m=g.listeners;v<m.length;v++){m[v].detailedUpdate()}});else for(var e=0,t=this.listeners;e<t.length;e++){t[e].detailedUpdate()}},e.prototype.getDataInRange=function(e,t){if(this.editor){var i=t||this.editor.document;if(i){var o=i.getText(e);if(0!==o.length){for(var n={},s=this.main.config.get("keywords",{}),r=0,d=Object.keys(s);r<d.length;r++){var a=d[r],u=Utils_1.default.getGroup(this.main,a),l=void 0,c=s[a].keyword?s[a].keyword:a,h=void 0===s[a].includesColon||s[a].includesColon,p=void 0===s[a].caseSensitive||s[a].caseSensitive,f=new RegExp("\\b("+c+(h?":":"")+")",(p?"":"i")+"gm");for(n[u]||(n[u]={amount:0,items:[],keywords:[]});l=f.exec(o);){var v=i.positionAt(l.index+i.offsetAt(e.start)),m=new vscode_1.Range(v,i.positionAt(l.index+i.offsetAt(e.start)+l[0].length-(h?1:0)));-1===n[u].keywords.indexOf(a)&&n[u].keywords.push(a),n[u].amount++,n[u].items.push({keyword:a,text:i.lineAt(v).text,range:m,container:e})}}return n}}}},e}();exports.default=Document;